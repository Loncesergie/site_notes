name: CI

on:
  push:
    branches: ["main", "master", "develop"]
  pull_request:
    branches: ["main", "master", "develop"]

permissions:
  contents: read
  security-events: write
  issues: write         # si vous voulez que ZAP ouvre/maj une issue
  pull-requests: read   # utile sur PR

jobs:
  ci:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.4"
          tools: composer:v2
          extensions: mbstring, pdo, pdo_mysql

      - name: Install dependencies
        run: composer install --no-interaction --no-progress --prefer-dist

      - name: Run unit tests (PHPUnit)
        run: vendor/bin/phpunit -c phpunit.xml

      - name: Static analysis (Psalm)
        run: vendor/bin/psalm --no-progress

      - name: Dependency security audit (Composer)
        run: composer audit --no-interaction

      - name: Secret scanning (Gitleaks)
        uses: gitleaks/gitleaks-action@v2

      # --- OWASP ZAP (DAST) : il faut une URL accessible ---
      # Option A : votre app tourne en local dans le runner via le serveur PHP
      - name: Start app (local)
        run: |
          # Adaptez "-t public" si votre docroot n'est pas "public"
          php -S 127.0.0.1:8000 -t public > /tmp/php-server.log 2>&1 &
          sleep 2
          curl -I http://127.0.0.1:8000 || (echo "App not reachable" && cat /tmp/php-server.log && exit 1)

      - name: OWASP ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.15.0
        with:
          target: "http://127.0.0.1:8000"
          rules_file_name: ".zap/rules.tsv"   # optionnel (voir plus bas)
          cmd_options: "-a -J zap.json -w zap.md"
          allow_issue_writing: true

      - name: Upload ZAP reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: zap-reports
          path: |
            zap.json
            zap.md
            report_html.html

